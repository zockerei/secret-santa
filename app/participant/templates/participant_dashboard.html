{% extends "base.html" %}

{% block title %}Wichtel-Dashboard{% endblock %}

{% block styles %}
    <link href="{{ url_for('participant.static', filename='css/style.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">üéÑ Frohe Weihnachten! üéÑ</h1> <!-- Christmas Greeting -->

    <!-- Add a decorative snowflake element -->
    <div class="snowflake"></div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            Aktueller Empf√§nger ({{ current_year }})
            <button class="btn btn-light btn-sm" data-toggle="collapse" data-target="#currentReceiverCollapse" aria-expanded="true" aria-controls="currentReceiverCollapse">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div id="currentReceiverCollapse" class="collapse show">
            <div class="card-body">
                {% if current_receiver %}
                    <p>Dein Wichtelpartner ist: <strong>{{ current_receiver.receiver_name }}</strong></p>
                    <h5>Nachricht von Deinem aktuellen Wichtelpartner</h5>
                    {% if current_receiver_message %}
                        <p>{{ current_receiver_message }}</p>
                    {% else %}
                        <p class="text-muted">Dein aktueller Wichtelpartner hat noch keine Nachricht geschrieben.</p>
                    {% endif %}
                {% else %}
                    <p class="text-muted">Du hast f√ºr dieses Jahr noch keinen Wichtelpartner zugewiesen.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            Fr√ºhere Wichtelpartner
            <button class="btn btn-light btn-sm" data-toggle="collapse" data-target="#pastReceiversCollapse" aria-expanded="true" aria-controls="pastReceiversCollapse">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div id="pastReceiversCollapse" class="collapse show">
            <div class="card-body">
                {% if past_receivers %}
                    <ul class="list-group">
                        {% for receiver in past_receivers %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ receiver.receiver_name }} ({{ receiver.year }})
                                <button class="btn btn-primary btn-sm" onclick="viewMessage({{ receiver.receiver_id }}, {{ receiver.year }}, '{{ receiver.receiver_name }}')">Nachricht anzeigen</button>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">Keine fr√ºheren Wichtelpartner gefunden.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            Schreiben Sie eine Nachricht f√ºr Deinen zuk√ºnftigen Wichtelpartner
            <button class="btn btn-light btn-sm" data-toggle="collapse" data-target="#writeMessageCollapse" aria-expanded="true" aria-controls="writeMessageCollapse">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div id="writeMessageCollapse" class="collapse show">
            <div class="card-body">
                <form action="{{ url_for('participant.add_message') }}" method="POST">
                    <div class="form-group">
                        <textarea class="form-control" name="message_text" rows="5" placeholder="Schreiben Sie hier Ihre Nachricht..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Nachricht senden</button>
                </form>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            Deine Nachricht f√ºr {{ current_year }}
            <button class="btn btn-light btn-sm" data-toggle="collapse" data-target="#pendingMessagesCollapse" aria-expanded="true" aria-controls="pendingMessagesCollapse">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div id="pendingMessagesCollapse" class="collapse show">
            <div class="card-body">
                {% if pending_messages %}
                    <ul class="list-group">
                        {% for message in pending_messages %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ message.message }} (Geschrieben f√ºr {{ message.year }})
                                <div>
                                    <a href="{{ url_for('participant.edit_message', message_id=message.id) }}" class="btn btn-warning btn-sm">Bearbeiten</a>
                                    <button class="btn btn-danger btn-sm" onclick="confirmDelete({{ message.id }})">L√∂schen</button>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">Keine ausstehenden Nachrichten gefunden.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <form action="{{ url_for('auth.logout') }}" method="POST" class="text-center">
        <button type="submit" class="btn btn-secondary">Abmelden</button>
    </form>
</div>

<!-- Nachricht Modal -->
<div id="messageModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Schlie√üen">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nachricht l√∂schen</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Schlie√üen">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Sind Sie sicher, dass Sie diese Nachricht l√∂schen m√∂chten?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Abbrechen</button>
                <form id="deleteForm" action="" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-danger">L√∂schen</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
    <script src="{{ url_for('participant.static', filename='js/script.js') }}"></script>
{% endblock %}
